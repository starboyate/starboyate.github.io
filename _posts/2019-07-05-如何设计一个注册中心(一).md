---
layout: post
title: "如何设计一个注册中心(一)"
subtitle: '注册中心杂谈'
author: "Starboyate"
header-img: "img/singleton.jpg"
multilingual: true
tags:
  - 分布式
  - 微服务
---

## 一、前言
> 在如今的互联网时代，分布式系统已经是见怪不怪了，随着分布式的深入，又诞生了微服务架构这样的
服务拆分分布式架构。更不用说现在容器服务、云服务概念的火爆，更是让微服务更加的受欢迎、追捧，
在分布式系统、微服务架构中，注册中心是最核心、重要的基础组件之一。本系列博客将会从介绍了解注册中心
到如何自己设计一个可用的注册中心，全方面的掌握注册中心！希望已经了解了CAP、BASE等理论，不知道的同学
可以自行去找一下。

<br/>

## 二、正文
##### 1.什么是注册中心？
> 顾名思义，就是一个用来提供服务注册的一个组件。我们可以把注册中心类比为通讯录，
里面存储了很多一个个服务对应的信息，比如服务的地址等等，当我们需要找某个服务的时候，
可以通过这个注册中心，去进行寻找发现。

<br/>

##### 2.为什么需要注册中心？
> 注册中心是一个分布式系统，微服务架构必须存在的基础组件之一，那为什么注册中心这么重要呢？

举个例子：现在有两个不同的服务，一个是服务A，一个是服务B，现在有一个需求，需要服务A去调用
服务B，如果没有注册中心是如何的呢？我们看看下面的图：

![01](/img/register-01.png)

<br/>

这种是最直接的方式，拿到服务B的地址，然后通过RPC调用服务B暴露出来的接口。
但是这样是不是就没有问题了呢？来分析下
- 假设，现在我多加了几十个服务，然后我可能一个请求，就需要从服务A调到
服务Z，这条链路特别的深、长。如下图：
![02](/img/register-02.png)

<br/>

我们可以看到每个服务都有着自己对应的地址，然后在A服务直接通过其它服务提供出来的地址，
然后一个个的去手动配置调用就行了。这样想想，好像确实可以，但是如果现在我突然某个服务的地址
改变了，如下图:
![03](/img/register-03.png)

<br/>

看粉色部分，全部的服务地址都改变了，由于我们是手动配置的服务A去调用其它服务，那这里我们也要
手动的去修改所有服务的地址，这里工作的繁琐，复杂，不易于管理，相信也都看出来了。

<br/>

- 假设现在还是服务A调用服务B，B服务是个核心服务，几乎无时无刻都在被调用，上面都是单个实例的，
发现撑不住了，这时候需要扩容了，我开了三个实例的服务B，如下图:
![04](/img/register-04.png)

<br/>

这时候如果我们想要调用B的其它实例是不是，必须要重启，然后在服务A里面又得配置其它服务B实例的地址，
可以看到这里其实是很麻烦的，这个就是一个服务发现的问题。

> 其实从上面的几点分析，可以看出，没有注册中心的时候，在一个服务拆分的系统中，服务之间的调用，发现
会变得特别复杂，繁琐。那如果多了服务注册中心呢？

![05](/img/register-05.png)

可以看到，多了注册中心后，就会把所有服务先往注册中心上面注册，服务的具体信息会放在一个服务清单中，
然后当服务A调用服务B的时候，会先去拉取清单下来，然后通过清单里面存储的服务B的地址，发起RPC调用。

<br/>

来看看多了服务注册中心后，是否解决了一开始的手动配置直连的问题
- 如果当服务B改变了地址，我们发现，因为服务B是会注册到注册中心上面的，所以，在这里，服务B会注册，
然后服务A重新拉取清单，然后进行更新就可以了，不需要手动的去改变配置。
- 当我们需要添加新的实例的时候，是不是也是一样的，会往里面去注册，然后我们服务A更新清单，是不是也解决了
上面的那些问题了。

<br/>

##### 3.服务注册中心提供的功能
> 上面的简单介绍了服务注册中心最重要的两个功能，服务注册和服务发现，但是仅仅这两个就够了吗？
其实是远远不够的，下面来看看一个优秀的注册中心应该提供的功能
- 服务注册
- 服务发现
- 服务健康检查
- 服务的高可用

提供的功能还有很多，这里列举出其中几个比较重要核心的。

<br/>

##### 4.流行服务注册中心对比
> 其实市面上有几款比较流行，受众面比较广的几款开源的注册中心，例如：eureka，etcd，zookeeper，consul 等等，
下面主要对比下这几款组件作为注册中心的一个优缺点。

| 开源组件 | 开发语言 | CAP | 服务健康检查 | 多数据中心 | 使用接口(多语言能力) | 具体使用地方 |
| :------: | :------: | :--------: | :-------: | :-------: | :-------: | :-------: |
| Eureka | Java | AP | 可配支持 | 无 | http（sidecar） | Spring Cloud |
| Etcd | Go | CP(raft算法保证一致性) | 心跳 | 无 | http,Etcd3支持grpc | Kubernetes |
| Zookeeper | Java | CP(ZAB算法保证一致性) | 长连接，keepalive | 无 | 客户端 | Dubbo |
| Consul | Go | CP(raft算法保证一致性) | 服务状态，内存，硬盘等 | 支持 | http,dns | spring cloud |
 
 通过上面的比较，我们发现了除了Eureka，其它的注册中心采取都是CP，牺牲了高可用性，只有Eureka是采用了AP，
 那么应该是采用AP还是CP呢，这个又是另一个话题了，具体可参考[阿里中间件博客这篇文章](http://jm.taobao.org/2018/06/13/%E5%81%9A%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%EF%BC%9F/),
 相信如果仔细读了这篇博客，就知道了注册中心应该是AP。
 
## 三、尾语
> 这篇博客主要是先对注册中心做个简单的介绍了解，后面的几篇博客，将会注重将如何设计一个可用的注册中心。
加油 ！


