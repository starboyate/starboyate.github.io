---
layout: post
title: "如何设计一个注册中心(二)"
subtitle: '注册中心的健康检查和高可用架构设计'
author: "Starboyate"
header-img: "img/singleton.jpg"
multilingual: true
tags:
  - 分布式
  - 微服务
---

## 一、前言
> 在上一篇博客[如何设计一个注册中心(二)](http://starboyate.com/2019/07/05/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83(%E4%B8%80)/)
介绍了如何设计注册中心两个核心功能，服务注册和服务发现，这篇会介绍最后两个功能，服务健康检查和高可用架构设计。

<br/>

## 二、正文
#### 1.服务健康检查
> 一个可用的注册中心，必定少不了健康检查这个核心功能，为什么需要这个功能呢？下面来具体分析

<br/>

##### 1.1 为什么需要健康检查？
其实就是为了检测各个服务在复杂的分布式网络的可用性，想想这么一个场景，假如现在我有两个服务，服务A和服务B已经注册到了注册中心，
并且各自也已经进行了发现，现在服务A调用服务B，那么在服务和网络可用的情况下，肯定是没问题的，但是假设现在，由于网络原因，导致服务
B网络不可达了，或者服务B突然宕机掉线了，那么，如果没有健康检查这个功能，是不是就意味着，这时候其实我服务A是不知道这个服务B挂了，我
还去调用，可能有些还做了重试机制的，那么就会在那里进行重试，这里其实是没有必要，浪费资源的，并且在线上运行的时候，可能服务B是个很高
流量的服务，突然挂了，最起码你得有某种机制进行监测通知，否则这里不就操蛋了吗，来看下图

<br/>

![09](/img/register-09.png)


##### 1.2 什么是健康检查？
> 无非就是为了检测服务是否可用，当服务出现问题、不可用的状态下，注册中心应该及时采取对应的策略做对应的处理。


<br/>

在我们设计之前先来看看优秀的开源注册中心都是如何来做这块的(其实前面的文章有简单的列举了不同组件的健康检查实现方式，这里主要看zookeeper和eureka)？
- zookeeper: 服务的健康检测常利用 ZooKeeper 的 Session 活性 Track机制 以及结合 Ephemeral ZNode的机制,具体可查看[阿里中间件这篇文章](http://jm.taobao.org/2018/06/13/%E5%81%9A%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%EF%BC%9F/)
- eureka: 其实eureka内部是有个叫做服务续约的东西，通过定时的向注册中心发送自己的租约信息(心跳)来维持，具体更多的健康信息需要集成Spring Boot Actuator来实现，然后注册中心根据服务是否可用，来执行服务剔除和服务自我保护等功能

通过上面可以发现，其实实现健康检查归为两个方法
- 客户端心跳
- 服务端TCP主动探测

##### 1.3 客户端心跳
> 相信心跳的一个设计，应该很多人都清楚如何去玩，其实无非就是我们定义好我们心跳包的一个数据结构，然后定时进行发送。如果是使用rpc方式，可以
通过netty提供的心跳handler来做，如果是http方式，那么应该在注册中心暴露一个接口出来供客户端进行调用发送，这里就不多描述这个心跳设计。

##### 1.4 服务下线
> 假设现在我们的一个心跳机制是每隔一分钟就往注册中心发送心跳，如果服务A宕机了，那么肯定发送不了心跳，那这里，注册中心那块应该如何处理呢？

当服务不可用了，注册中心如何处理？
- 其实这里我们可以参考eureka的一个实现方式，如果一个服务超过一定的时间间隔了，我还没有收到心跳包，那么我认为这个服务不可用了，就执行服务下线操作了
- 只是这么简单的下线就可以了吗？其实不是的，相信熟悉eureka的，都清楚，eureka有个叫做自我保护机制，就是当我突然间服务下线了超过了85%，那么就会进入
自我保护机制，不再剔除下线服务，保障了一个服务的可用性，这里为什么要这么做呢？这是因为在分布式网络中，会有网络波动，加上eureka又是AP模型，所以情愿保留
不可用的服务信息，而不是就全部剔除掉，这样如果只是由于网络波动了，那么也不会影响我服务之间的调用。

<br/>

所以我们也应该根据自己的一个需求采取合理的处理方案，这里推荐参考eureka来设计，所以我们可以这样设计
- 定时发送心跳，当心跳丢包达到一定程度，那么我们可以在注册中心里面把这个对应的服务放入到一个待下线的容器中或者进行标记
- 如果在某一刻，突然大量的服务被标记为下线了或者进入到了待下线的容器中，那么我们应该采取保护策略，可以把这些服务放入一个自我保护的容器中
- 如果突然在我们打算清理下线服务过程中，服务又重新恢复了通信，这里应该怎么办？其实这里应该转为服务注册，也就是服务应该进行重新注册

<br/>

#### 2.高可用注册中心架构
> 其实到这里，整个注册中心基本具备的功能都已经具备了，但是现在我们的注册中心只是单节点的架构，无法保证高可用性，所以下面来看看如何设计高可用的注册中心

先来设计一个重要的问题，如何进行多节点数据的同步？
- 这里可以采取gossip协议来实现，具体的可以自行去找资料

##### 2.1 主从架构
> 相信主从架构都不陌生了，很多优秀的开源组件都有这样的架构方式，下面来看看如何设计主从架构

注册中心如何做主从？
- 全量注册机制。什么意思呢，假设现在我有三个节点，那么应该让这三个节点互相进行同步信息，也就相当于每个注册中心，都往其它注册中心进行注册拉取全部的信息，每个节点保存的信息其实是一模一样的。
- 分片机制。就是我还是多个注册中心进行互相注册，但是这时候我采取一种拆分存储机制，就是我把注册中心的那个注册信息容器进行了拆分，比如现在是三个节点，那么我就划分成为
三份数据，然后第一个节点保存第一份，第二个节点保存第二份，第三个节点保存第三份。
- 多副本冗余分片机制。这个其实就是在分片机制上多了一个每个节点上都保存了其他节点的一个副本，来保障了数据的可靠、可用性。

<br/>

##### 2.2 多节点架构
> 摒弃主从架构，就来个多个节点进行互相注册，不需要区分master、slave，其实我们的注册中心是不是更应该是这种架构，不需要所谓的主从关系，
每个节点的注册中心都可以单独的对外提供服务，读写都可以，并且主从还会相对复杂。

如何设计多节点架构？
- 可以通过让用户手动配置多个注册中心的地址，然后我们获取配置来进行多个节点之间的互相注册
- 提供动态的加入新的注册中心，实现多个节点之间的互相注册。什么意思呢，就是说现在我本来跑了两个注册中心，但是现在我需要扩容了，
动态加入一个注册中心，那得保证我这个扩容的节点能够加入这个多节点架构中，这里就涉及到了一个服务的无状态化，因为只有无状态的服务是
可以进行动态的扩容。所以我们的注册中心也应该是个无状态的基础服务。
- 应该实现负载均衡，来决定服务注册应该注册到哪一个节点上，这里可以采取一致性hash等等算法。
- 最后，应该节点之间通过gossip同步注册信息。

<br/>

如何实现动态发现注册中心，加入到多节点架构中呢？
- 暴露一个接口，然后手动的去调这个接口，实现这个功能。
- 可以通过配置中心这样的组件，把扩容的新节点，写入到配置中心，然后动态刷新

## 三、尾语
> 这里就介绍了注册中心的健康检查和高可用架构如何设计，到这里也代表着如何设计一个注册中心系列文章已经结束了。相信通过这三篇文章，
也可以很清晰的了解到了注册中心，一起加油 ！
